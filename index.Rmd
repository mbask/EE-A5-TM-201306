---
title       : A5 Technical meeting
subtitle    : Jyväskylä (Finland), June 18, 2013
author      : Giorgio Matteucci, Marco Bascietto
job         : CNR - IBAF
framework   : io2012        # {io2012, html5slides, shower, dzslides, ...}
highlighter : highlight.js  # {highlight.js, prettify, highlight}
hitheme     : tomorrow      # 
widgets     : []            # {mathjax, quiz, bootstrap}
mode        : selfcontained # {standalone, draft}
github:
  user: mbask
  repo: EE-A5-TM-201306
---
```{r "libraryLoad", cache=FALSE, include=FALSE, echo=FALSE}
library(data.table)
library(RSQLite)
library(sqlutils)
library(plyr)
library(xtable)
suppressPackageStartupMessages(library(googleVis))

options(gvis.plot.tag='chart')
assignInNamespace("cedta.override","slidify","data.table") 
```


```{r "functions", cache=TRUE, include=FALSE, echo=FALSE}
countryPlot <- function(country_df, id) {
  plot(
    gvisMap(
      country_df
      , locationvar = "latLong"
      , tipvar      = "siteName"
      , options     = list(
        mapType     = 'terrain'
        , useMapTypeControl = TRUE
        , width = 800
        , height = 200
        )
      , chartid = paste0("CountryAndDomainPlot", id)
      )
    )
  }
printAggrData <- function(country_df) {
  print(
    xtable(
      head(country_df[with(country_df, order(-Sites)), ], 15))
      , type = 'html'
      , html.table.attributes = ''
      , include.rownames = FALSE
    )
}
aggregatreByParameter <- function(country_df) {
  if (nrow(country_df) > 0) {
    tmp_df <- ddply(
      country_df
      , .(parameterName)
      , summarize
      , Count = length(parameterName)
      )
  } else {
    tmp_df <- data.frame(parameterName = "None", Count = "N/A")
  }
  colnames(tmp_df) <- c("Parameter name", "Sites")
  tmp_df
}
```

```{r "dbSetup", cache=FALSE, include=FALSE, echo=FALSE}
# Setup e connessione SQLite -----------------------------------------------


sqlPaths("~/Documents/Academy/IBAF/ENVEUROPE/A5Finland/sql")

db.sqlite.cfg  <- list(
  fName    = "~/Documents/Academy/IBAF/ENVEUROPE/A5/DB/EEA5SiteParameters.db"
  , driver =  dbDriver("SQLite")
  , query  = list("getAvailableDataByCountry", "getAvailableDataByDomain")
  , queryTitle = list("Uploaded Data by country", "Uploaded data by domain")
  , countryNames = c("Austria", "Bulgaria", "Finland", "Germany", "Hungary", "Italy", "Lithuania", "Poland", "Romania", "Spain", "Sweden")
  , domainNames = c("Terrestrial", "Freshwater-lake", "Freshwater-river", "Marine")
)

dbConnection <- with(db.sqlite.cfg, dbConnect(driver, dbname = fName))

```

## Statistiche generali

1. Edit YAML front matter
2. Write using R Markdown
3. Use an empty line followed by three dashes to separate slides!

---
## Andamento della sottomissione



---
## Problemi incontrati nella sottomissione

* FTP
* DEIMS
* Data tool
* Google Drive



---
## Proposte di soluzioni

* FTP
* DEIMS
* Data tool
*publish("mbask", "EE-A5-TM-201306")
 Google Drive



---
## Statistiche per Nazione

```{r "countryRawDataQuery", echo=FALSE, cache=FALSE}
sqlQueryToDataTable <- function(countryName, sqlQuery = db.sqlite.cfg$query[[1]]) {
  data.table(
    execQuery(sqlQuery, connection = dbConnection, countryName = countryName)
    , key = c("siteLTERCode", "siteName", "domainName")
  )
}
# Get Country data
countryRawData_l <- lapply(db.sqlite.cfg$countryNames, sqlQueryToDataTable)
# Convert Lat and Long coordinates in Lat:Long
countryRawData_l <- lapply(
  countryRawData_l
  , function(country_dt) country_dt[, latLong := paste(siteLat, siteLong, sep = ":")]
  )

# Aggregate per parameter name
countryAggrData_l <- countryRawData_l
countryAggrData_l <- lapply(countryAggrData_l, aggregatreByParameter)
```


---
## Austria

```{r "Austria", echo=FALSE, cache=FALSE, results='asis', warning=FALSE}
tmpCountry <- 1
countryPlot(unique(countryRawData_l[[tmpCountry]]), db.sqlite.cfg$countryNames[tmpCountry])
printAggrData(countryAggrData_l[[tmpCountry]])
```


---
## Bulgaria

```{r "Bulgaria", echo=FALSE, cache=FALSE, results='asis', warning=FALSE}
tmpCountry <- 2
countryPlot(unique(countryRawData_l[[tmpCountry]]), db.sqlite.cfg$countryNames[tmpCountry])
printAggrData(countryAggrData_l[[tmpCountry]])
```




---
## Finland

```{r "Finland", echo=FALSE, cache=FALSE, results='asis', warning=FALSE}
tmpCountry <- 3
countryPlot(unique(countryRawData_l[[tmpCountry]]), db.sqlite.cfg$countryNames[tmpCountry])
printAggrData(countryAggrData_l[[tmpCountry]])
```


---
## Germany

```{r "Germany", echo=FALSE, cache=FALSE, results='asis', warning=FALSE}
tmpCountry <- 4
countryPlot(unique(countryRawData_l[[tmpCountry]]), db.sqlite.cfg$countryNames[tmpCountry])
printAggrData(countryAggrData_l[[tmpCountry]])
```



---
## Hungary

```{r "Hungary", echo=FALSE, cache=FALSE, results='asis', warning=FALSE}
tmpCountry <- 5
countryPlot(unique(countryRawData_l[[tmpCountry]]), db.sqlite.cfg$countryNames[tmpCountry])
printAggrData(countryAggrData_l[[tmpCountry]])
```



---
## Italy

```{r "Italy", echo=FALSE, cache=FALSE, results='asis', warning=FALSE}
tmpCountry <- 6
countryPlot(unique(countryRawData_l[[tmpCountry]]), db.sqlite.cfg$countryNames[tmpCountry])
printAggrData(countryAggrData_l[[tmpCountry]])
```



---
## Lithuania

```{r "Lithuania", echo=FALSE, cache=FALSE, results='asis', warning=FALSE}
tmpCountry <- 7
countryPlot(unique(countryRawData_l[[tmpCountry]]), db.sqlite.cfg$countryNames[tmpCountry])
printAggrData(countryAggrData_l[[tmpCountry]])
```


---
## Poland

```{r "Poland", echo=FALSE, cache=FALSE, results='asis', warning=FALSE}
tmpCountry <- 8
countryPlot(unique(countryRawData_l[[tmpCountry]]), db.sqlite.cfg$countryNames[tmpCountry])
printAggrData(countryAggrData_l[[tmpCountry]])
```


---
## Romania

```{r "Romania", echo=FALSE, cache=FALSE, results='asis', warning=FALSE}
tmpCountry <- 9
countryPlot(unique(countryRawData_l[[tmpCountry]]), db.sqlite.cfg$countryNames[tmpCountry])
printAggrData(countryAggrData_l[[tmpCountry]])
```


---
## Spain

```{r "Spain", echo=FALSE, cache=FALSE, results='asis', warning=FALSE}
tmpCountry <- 10
countryPlot(unique(countryRawData_l[[tmpCountry]]), db.sqlite.cfg$countryNames[tmpCountry])
printAggrData(countryAggrData_l[[tmpCountry]])
```


---
## Sweden

```{r "Sweden", echo=FALSE, cache=FALSE, results='asis', warning=FALSE}
tmpCountry <- 11
countryPlot(unique(countryRawData_l[[tmpCountry]]), db.sqlite.cfg$countryNames[tmpCountry])
printAggrData(countryAggrData_l[[tmpCountry]])
```


---
## Stat aggregate per dominio


```{r "domainRawDataQuery", echo=FALSE, cache=FALSE}
sqlDomainQueryToDataTable <- function(domainName, sqlQuery = db.sqlite.cfg$query[[2]]) {
  data.table(
    execQuery(sqlQuery, connection = dbConnection, domainName = domainName)
    , key = c("siteLTERCode", "siteName", "domainName")
  )
}
# Get Country data
domainRawData_l <- lapply(db.sqlite.cfg$domainNames, sqlDomainQueryToDataTable)
# Convert Lat and Long coordinates in Lat:Long
domainRawData_l <- lapply(
  domainRawData_l
  , function(domain_dt) domain_dt[, latLong := paste(siteLat, siteLong, sep = ":")]
  )
# Aggregate per parameter name
domainAggrData_l <- domainRawData_l
domainAggrData_l <- lapply(domainAggrData_l, aggregatreByParameter)
```


---
## Terrestrial

```{r "Terrestrial", echo=FALSE, cache=FALSE, results='asis', warning=FALSE}
tmpDomain <- 1
countryPlot(unique(domainRawData_l[[tmpDomain]]), db.sqlite.cfg$domainNames[tmpDomain])
printAggrData(domainAggrData_l[[tmpDomain]])
```


---
## Freshwater-lake

```{r "Freshwater-lake", echo=FALSE, cache=FALSE, results='asis', warning=FALSE}
tmpDomain <- 2
countryPlot(unique(domainRawData_l[[tmpDomain]]), db.sqlite.cfg$domainNames[tmpDomain])
printAggrData(domainAggrData_l[[tmpDomain]])
```


---
## Freshwater-river

```{r "Freshwater-river", echo=FALSE, cache=FALSE, results='asis', warning=FALSE}
tmpDomain <- 3
countryPlot(unique(domainRawData_l[[tmpDomain]]), db.sqlite.cfg$domainNames[tmpDomain])
printAggrData(domainAggrData_l[[tmpDomain]])
```


---
## Marine

```{r "Marine", echo=FALSE, cache=FALSE, results='asis', warning=FALSE}
tmpDomain <- 4
countryPlot(unique(domainRawData_l[[tmpDomain]]), db.sqlite.cfg$domainNames[tmpDomain])
printAggrData(domainAggrData_l[[tmpDomain]])
```


---
## Kick off discussion

1. Obiettivo: pubblicazione peer-review
2. Analisi spaziale (non temporale)

* Panel esperti di dominio? -> 3 progetti
* Singolo panel inter-domain? -> 1 progettone
* 

```{r "closeDBConnection", cache=FALSE, include=FALSE, echo=FALSE}
dbDisconnect(dbConnection)
```